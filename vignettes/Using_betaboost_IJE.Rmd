---
title: "The betaboost package: A software tool for modeling bounded outcome variables in potentially high-dimensional epidemiological data -- Appendix"
author: "Andreas Mayr, Leonie Weinhold, Benjamin Hofner, Stephanie Titze, Olaf Gefeller, Matthias Schmid"
date: ""
output:
  html_document:
    keep_md: yes
---

<!--
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Using package betaboost}
-->

## Preparations and initialisation

In order to be able to execute the following code, one first needs to install 
the following packages (along with `betaboost`):
```{r initialization, eval = FALSE}
## Install packages
install.packages(c("QoLR",           ## install package for data set dataqol2
                   "betareg"))       ## install betareg for comparison of results  
```

Next, we load the `betaboost` package
```{r load_package, message=FALSE, warning=FALSE}
library("betaboost")                 ## load betaboost
```

## Example 1: Comparison of various boosted models

First, we analyse publicly available data on health-realated quality of life of 60 patients. The data set is available as `dataqol2` in the `QoLR` package. The explanatory variables are the treatment group (`arm`) and an additional score measuring the patients `pain`. First, we load and preprocess the data:

```{r load_data}
## load data
data("dataqol2", package = "QoLR")
## take one time-point
dataqol <- dataqol2[dataqol2$time ==0,]
## remove missings
dataqol <- dataqol[complete.cases(dataqol[,c("QoL", "arm", "pain")]),]
## rescale outcome to [0,1]
dataqol <- dataqol/100
```

### Raw data

The data set consists of `r ncol(dataqol)` variables and `r nrow(dataqol)`
observations.
```{r}
str(dataqol)
``` 

The raw outcome is distributed as follows
```{r outcome}
hist(dataqol$QoL, breaks = 20, col = "lightgrey", 
     main = "Quality of life", prob = TRUE, las = 1)
lines(density(dataqol$QoL), col = 2, lwd = 2)
```

The influence of various predictors on the outcome is depicted in the following
```{r outcome by predictor variables}
## QOL by treatment arm
boxplot(QoL ~ arm, data = dataqol, names = c("A","B"), las = 1,
        col = "lightgrey", ylab = "Qualitiy of life")
## QOL by pain
plot(QoL ~ pain, data = dataqol, pch = 19, las = 1)
abline(lm(QoL ~ pain, data = dataqol))
```

### Boosted beta models

First, we fit a classical beta regression with linear effects
```{r}
beta1 <- betaboost(QoL ~ pain + arm, data = dataqol)
coef(beta1, off2int = TRUE)
```
the precission parameter is treated as nuissance
```{r}
nuisance(beta1)
```

Similarly, we can fit a model with smooth effect for pain
```{r}
beta2 <- betaboost(QoL ~ s(pain) + arm, data = dataqol, 
                   form.type = "classic")
```
and plot partial smooth effect
```{r}
plot(beta2, which = "pain")
```

As for all boosting methods, we need to tune the model (via cross-validation). 
This takes a few seconds.
```{r}
set.seed(1234)
cvr <- cvrisk(beta2)
## exract optimal boosting iteration as determined via cross-validation
mstop(cvr)
## and plot the cross-validated risk over the iterations
plot(cvr)
## set to optimal stopping iterations
mstop(beta2) <- mstop(cvr)
```
Of note, `pain` is no longer selected:
```{r}
coef(beta2)
```

Now, we fit an extended beta regression model, where the precision parameter is 
modeled as well
```{r}
beta3 <- betaboost(QoL ~ arm + pain, 
                   phi.formula = QoL ~ arm + pain, 
                   data = dataqol)
coef(beta3, off2int = TRUE)
```

We fit the model again with a smooth effect for pain:
```{r}
beta4 <- betaboost(QoL ~ arm + s(pain), 
                   phi.formula = QoL ~ arm + s(pain),
                   data = dataqol, form.type = "classic")
par(mfrow = c(1,2))
plot(beta4, which =  "pain")
```

### Compare R$^2$ measures for the four boosting models

```{r}
cbind("lin" = R2.betaboost(beta1, data = dataqol), 
      "smooth" = R2.betaboost(beta2[100], data = dataqol),
      "ext. lin" = R2.betaboost(beta3, data = dataqol),
      "ext. smooth" = R2.betaboost(beta4, data = dataqol))
```

## Example 2: Comparison of `betareg` and `betaboost`

```{r init, warning=FALSE, message=FALSE}
## load betareg and data
library(betareg)
data(FoodExpenditure)
``` 

First, we fit the standard beta regression model to the data
```{r}
beta1 <- betareg(I(food/income) ~ income + persons, 
                 data = FoodExpenditure)
```

Now, we fit a boosted beta regression model
```{r}
beta2 <- betaboost(I(food/income) ~ income + persons, 
                   data = FoodExpenditure)
```

If we compare the estimated coefficients of the methods 
```{r}
rbind("betareg" = coef(beta1), 
      "betaboost" = c(coef(beta2, off2int = TRUE), 
                      nuisance(beta2)))
```
we see that there are only minor differences. If we increase the number of boosting
iterations, we converge to the standard solution:
```{r}
mstop(beta2) <- 500
## compare again
rbind("betareg" = coef(beta1), 
      "betaboost" = c(coef(beta2, off2int = TRUE), 
                      nuisance(beta2)))
```
As we see from the following plot, changes in the coefficients were very slow after the
first 100 boosting iterations:
```{r}
plot(beta2, off2int = TRUE, main = "boosting")
```
